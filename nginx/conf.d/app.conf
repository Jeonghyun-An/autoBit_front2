# WebSocket 지원을 위한 맵
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

# 업스트림 정의 (로드밸런싱/장애복구용)
upstream nuxt_upstream {
  server nuxt:3000;
}

upstream fastapi_upstream {
  server fastapi:8000;
}

server {
  listen 80;
  server_name _;

  client_max_body_size 200M;

  # 헬스체크 엔드포인트
  location = /healthz {
    return 200 'ok';
    add_header Content-Type text/plain;
  }

  # landsoft.co.kr 컨텍스트 추가 (팀장님 요청사항)
  location /rag {
    # 홈을 /chat으로 리다이렉트
    location = /rag {
      return 302 /rag/chat;
    }

    # FastAPI 경로
    location /rag/llama/ {
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      
      # 타임아웃 설정 (파일 업로드/처리용)
      proxy_connect_timeout 60s;
      proxy_send_timeout 600s;
      proxy_read_timeout 600s;

      # /rag/llama/ -> /llama/로 리다이렉트
      rewrite ^/rag/llama/(.*) /llama/$1 break;
      proxy_pass http://fastapi_upstream;
    }

    # Nuxt.js (RAG 컨텍스트 하위 모든 경로)
    location /rag/ {
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_Set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      
      # Nuxt 개발 서버 HMR 지원
      proxy_cache_bypass $http_upgrade;
      
      # /rag/ -> / 로 변환해서 nuxt에 전달
      rewrite ^/rag/(.*) /$1 break;
      proxy_pass http://nuxt_upstream/;
    }
  }

  # 기존 루트 경로도 유지 (개발/테스트용)
  location = / {
    return 302 /chat;
  }

  # FastAPI 경로 (기존 유지)
  location /llama/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    
    proxy_connect_timeout 60s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;

    proxy_pass http://fastapi_upstream;
  }

  location = /llama {
    return 301 /llama/;
  }

  # 기존 Nuxt.js 경로 (기존 유지)
  location / {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_Set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    
    proxy_cache_bypass $http_upgrade;
    proxy_pass http://nuxt_upstream/;
  }
}